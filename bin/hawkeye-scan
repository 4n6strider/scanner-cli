#!/usr/bin/env node
const Scan = require('../lib/scan');
const logger = new require('../lib/logger')();
const fs = require('fs');
const scanSummaryWriter = new require('../lib/summaryWriter')();
const path = require('path');

let program = require('commander');
program
  .option('-t, --target </path/to/project>', 'The location of the project root', val => {
    if(!fs.existsSync(val)) {
      throw new Error(val + ' does not exist!');
    }
    return val;
  })
  .option('-m, --modules <module1,module2>', 'Run specific module(s)', (val) => {
    return val.split(',');
  })
  .option('-o, --output </path/to/results.json>', 'Output the detailed JSON', val => {
    let dir = path.dirname(val);
    if(!fs.existsSync(dir)) {
      throw new Error(dir + ' does not exist!');
    }
    return val;
  })
  .parse(process.argv);

let target = program.target || process.env.PWD;
let modules = program.modules || ['all'];

let scan = new Scan(target);

scan.start(modules, (err, results) => {
  let total = 0;
  results.forEach(moduleResult => {
    Object.keys(moduleResult.results).forEach(key => {
      total = total + moduleResult.results[key].length;
    });
  });
  logger.log('scan complete, ' + total + ' issues found');
  console.log('');
  scanSummaryWriter.write(results);

  if(program.output) {
    fs.writeFileSync(program.output, JSON.stringify(results, null, 2));
    logger.log('json results written to: ' + program.output);
  }
});
